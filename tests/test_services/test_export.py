"""Tests for export service."""

import json
from datetime import datetime

import pytest

from src.models.content import (
    ContentOutline,
    ContentRequest,
    ContentResponse,
    ContentStatus,
    ContentType,
    ResearchResult,
)
from src.services.export_service import ExportFormat, ExportService


@pytest.fixture
def sample_content():
    """Create sample content for testing."""
    return ContentResponse(
        id="test-123",
        status=ContentStatus.COMPLETED,
        request=ContentRequest(
            topic="AI in Content Marketing: A Complete Guide",
            content_type=ContentType.BLOG_POST,
            target_audience="Digital marketers",
            tone="professional",
            language="en",
            word_count=1500,
            keywords=["AI", "content marketing", "automation"],
        ),
        content="""# Introduction

This is the **introduction** to AI in content marketing.

## Benefits of AI

- Increased efficiency
- Better personalization
- Cost savings

### Automation Tools

Here are some tools:

1. Tool A
2. Tool B
3. Tool C

> AI is transforming the marketing landscape - Expert

## Conclusion

Start using AI today!
""",
        outline=ContentOutline(
            title="AI in Content Marketing: A Complete Guide",
            hook="Transform your marketing with AI",
            sections=[
                {"header": "Introduction", "purpose": "Set context", "points": ["Overview"]},
                {
                    "header": "Benefits of AI",
                    "purpose": "Show value",
                    "points": ["Efficiency", "Personalization"],
                },
            ],
            conclusion_points=["AI is essential", "Start now"],
            cta="Get started with AI today",
        ),
        research=ResearchResult(
            key_facts=["AI adoption is growing rapidly"],
            statistics=["80% of marketers use AI tools"],
            quotes=["AI is the future of marketing"],
            competitor_insights=["Competitors are adopting AI"],
        ),
        created_at=datetime(2025, 1, 15, 10, 30, 0),
        completed_at=datetime(2025, 1, 15, 10, 30, 30),
        processing_time_seconds=30.0,
    )


class TestExportFormats:
    """Test export format enum."""

    def test_all_formats_defined(self):
        """Test all expected formats are defined."""
        assert ExportFormat.MARKDOWN.value == "markdown"
        assert ExportFormat.HTML.value == "html"
        assert ExportFormat.PDF.value == "pdf"
        assert ExportFormat.JSON.value == "json"
        assert ExportFormat.TXT.value == "txt"


class TestMarkdownExport:
    """Test Markdown export."""

    def test_markdown_export_basic(self, sample_content):
        """Test basic Markdown export."""
        result = ExportService.export(sample_content, ExportFormat.MARKDOWN)
        markdown = result.decode("utf-8")

        # Check YAML frontmatter
        assert markdown.startswith("---")
        assert "topic:" in markdown
        assert "AI in Content Marketing" in markdown

        # Check content is present
        assert "Introduction" in markdown
        assert "Benefits of AI" in markdown

        # Check footer
        assert "Generated by Content Mate" in markdown

    def test_markdown_export_includes_keywords(self, sample_content):
        """Test Markdown export includes keywords in frontmatter."""
        result = ExportService.export(sample_content, ExportFormat.MARKDOWN)
        markdown = result.decode("utf-8")

        assert "keywords:" in markdown
        assert "AI" in markdown

    def test_markdown_export_empty_content(self, sample_content):
        """Test Markdown export with no content."""
        sample_content.content = None
        result = ExportService.export(sample_content, ExportFormat.MARKDOWN)
        markdown = result.decode("utf-8")

        assert "*No content generated*" in markdown


class TestHTMLExport:
    """Test HTML export."""

    def test_html_export_structure(self, sample_content):
        """Test HTML export has proper structure."""
        result = ExportService.export(sample_content, ExportFormat.HTML)
        html = result.decode("utf-8")

        assert "<!DOCTYPE html>" in html
        assert "<html" in html
        assert "</html>" in html
        assert "<head>" in html
        assert "<body>" in html
        assert "<article>" in html

    def test_html_export_title(self, sample_content):
        """Test HTML export has correct title."""
        result = ExportService.export(sample_content, ExportFormat.HTML)
        html = result.decode("utf-8")

        assert "<title>" in html
        assert "AI in Content Marketing" in html

    def test_html_export_has_meta_tags(self, sample_content):
        """Test HTML export includes meta tags."""
        result = ExportService.export(sample_content, ExportFormat.HTML)
        html = result.decode("utf-8")

        assert 'name="generator"' in html
        assert 'name="keywords"' in html
        assert "og:title" in html

    def test_html_export_has_styles(self, sample_content):
        """Test HTML export includes CSS styles."""
        result = ExportService.export(sample_content, ExportFormat.HTML)
        html = result.decode("utf-8")

        assert "<style>" in html
        assert "font-family" in html

    def test_html_markdown_conversion(self, sample_content):
        """Test Markdown to HTML conversion."""
        result = ExportService.export(sample_content, ExportFormat.HTML)
        html = result.decode("utf-8")

        # Headers converted
        assert "<h2>" in html or "<h1>" in html

        # Bold text converted
        assert "<strong>" in html

        # Lists converted
        assert "<li>" in html


class TestJSONExport:
    """Test JSON export."""

    def test_json_export_valid(self, sample_content):
        """Test JSON export is valid JSON."""
        result = ExportService.export(sample_content, ExportFormat.JSON)
        data = json.loads(result.decode("utf-8"))

        assert isinstance(data, dict)
        assert "id" in data
        assert "content" in data
        assert "request" in data

    def test_json_export_includes_all_fields(self, sample_content):
        """Test JSON export includes all expected fields."""
        result = ExportService.export(sample_content, ExportFormat.JSON)
        data = json.loads(result.decode("utf-8"))

        assert data["id"] == "test-123"
        assert data["status"] == "completed"
        assert data["request"]["topic"] == "AI in Content Marketing: A Complete Guide"
        assert data["outline"] is not None
        assert data["research"] is not None
        assert data["metadata"]["processing_time_seconds"] == 30.0

    def test_json_export_request_details(self, sample_content):
        """Test JSON export includes request details."""
        result = ExportService.export(sample_content, ExportFormat.JSON)
        data = json.loads(result.decode("utf-8"))

        request = data["request"]
        assert request["content_type"] == "blog_post"
        assert request["target_audience"] == "Digital marketers"
        assert "AI" in request["keywords"]

    def test_json_export_outline(self, sample_content):
        """Test JSON export includes outline."""
        result = ExportService.export(sample_content, ExportFormat.JSON)
        data = json.loads(result.decode("utf-8"))

        outline = data["outline"]
        assert outline["title"] == "AI in Content Marketing: A Complete Guide"
        assert len(outline["sections"]) == 2


class TestPlainTextExport:
    """Test plain text export."""

    def test_txt_export_basic(self, sample_content):
        """Test plain text export."""
        result = ExportService.export(sample_content, ExportFormat.TXT)
        text = result.decode("utf-8")

        # Title should be uppercase
        assert "AI IN CONTENT MARKETING" in text

        # Content should be stripped of markdown
        assert "Introduction" in text
        assert "Benefits of AI" in text

        # Should not contain markdown syntax
        assert "**" not in text
        assert "##" not in text

    def test_txt_export_strips_markdown(self, sample_content):
        """Test plain text export removes markdown formatting."""
        result = ExportService.export(sample_content, ExportFormat.TXT)
        text = result.decode("utf-8")

        # No markdown headers
        assert text.count("#") == 0

        # No bold markers
        assert "**" not in text

        # No list markers
        # Bullet points should be removed
        lines = text.split("\n")
        bullet_lines = [line for line in lines if line.strip().startswith("-")]
        assert len(bullet_lines) == 0


class TestPDFExport:
    """Test PDF export."""

    def test_pdf_export_returns_html(self, sample_content):
        """Test PDF export returns print-ready HTML."""
        result = ExportService.export(sample_content, ExportFormat.PDF)
        html = result.decode("utf-8")

        # Should be HTML (until weasyprint is integrated)
        assert "<!DOCTYPE html>" in html
        assert "@page" in html  # Print-specific CSS
        assert "size: A4" in html


class TestFilenameGeneration:
    """Test filename generation."""

    def test_filename_from_topic(self, sample_content):
        """Test filename is generated from topic."""
        filename = ExportService.get_filename(sample_content, ExportFormat.MARKDOWN)

        assert filename.endswith(".md")
        assert "ai-in-content-marketing" in filename.lower()

    def test_filename_extensions(self, sample_content):
        """Test correct extensions for each format."""
        assert ExportService.get_filename(sample_content, ExportFormat.MARKDOWN).endswith(".md")
        assert ExportService.get_filename(sample_content, ExportFormat.HTML).endswith(".html")
        assert ExportService.get_filename(sample_content, ExportFormat.PDF).endswith(".pdf")
        assert ExportService.get_filename(sample_content, ExportFormat.JSON).endswith(".json")
        assert ExportService.get_filename(sample_content, ExportFormat.TXT).endswith(".txt")

    def test_filename_special_characters_removed(self, sample_content):
        """Test special characters are removed from filename."""
        sample_content.request.topic = "Test: A Guide! (2025) - Updated"
        filename = ExportService.get_filename(sample_content, ExportFormat.MARKDOWN)

        assert ":" not in filename
        assert "!" not in filename
        assert "(" not in filename


class TestContentTypeMapping:
    """Test MIME content type mapping."""

    def test_content_types(self):
        """Test content types are correct."""
        assert ExportService.get_content_type(ExportFormat.MARKDOWN) == "text/markdown"
        assert ExportService.get_content_type(ExportFormat.HTML) == "text/html"
        assert ExportService.get_content_type(ExportFormat.PDF) == "application/pdf"
        assert ExportService.get_content_type(ExportFormat.JSON) == "application/json"
        assert ExportService.get_content_type(ExportFormat.TXT) == "text/plain"


class TestMarkdownToHTMLConversion:
    """Test internal Markdown to HTML conversion."""

    def test_headers_conversion(self):
        """Test header conversion."""
        html = ExportService._markdown_to_html("# H1\n## H2\n### H3")

        assert "<h1>" in html
        assert "<h2>" in html
        assert "<h3>" in html

    def test_bold_conversion(self):
        """Test bold text conversion."""
        html = ExportService._markdown_to_html("This is **bold** text")

        assert "<strong>bold</strong>" in html

    def test_italic_conversion(self):
        """Test italic text conversion."""
        html = ExportService._markdown_to_html("This is *italic* text")

        assert "<em>italic</em>" in html

    def test_code_conversion(self):
        """Test inline code conversion."""
        html = ExportService._markdown_to_html("Use `code` here")

        assert "<code>code</code>" in html

    def test_blockquote_conversion(self):
        """Test blockquote conversion."""
        html = ExportService._markdown_to_html("> This is a quote")

        assert "<blockquote>" in html


class TestMarkdownStripping:
    """Test Markdown stripping for plain text."""

    def test_strip_headers(self):
        """Test header markers are stripped."""
        text = ExportService._strip_markdown("# Header 1\n## Header 2")

        assert "#" not in text
        assert "Header 1" in text
        assert "Header 2" in text

    def test_strip_bold_italic(self):
        """Test bold and italic markers are stripped."""
        text = ExportService._strip_markdown("**bold** and *italic*")

        assert "**" not in text
        assert "*" not in text.replace("bold", "")  # Only check for marker asterisks
        assert "bold" in text
        assert "italic" in text

    def test_strip_code_blocks(self):
        """Test code blocks are removed."""
        text = ExportService._strip_markdown("Before\n```python\ncode\n```\nAfter")

        assert "```" not in text
        assert "Before" in text
        assert "After" in text

    def test_strip_links(self):
        """Test links are converted to text."""
        text = ExportService._strip_markdown("Click [here](https://example.com)")

        assert "[" not in text
        assert "here" in text
        assert "https://example.com" not in text
